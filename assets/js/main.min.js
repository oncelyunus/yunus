$(document).ready(function () {

    $('.lang-select').select2({
        theme: 'fizy',
        minimumResultsForSearch: Infinity,
        language: 'tr'
    });

    $('#langSelector').change(function () {
        var newLang = $(this).val();
        var parameters = window.location.search.substring(1);

        if (!parameters) {
            getParameter = '';
        } else {
            getParameter = "?" + parameters;
        }
        window.location.replace(newLang + '.html' + getParameter);
    });

    const mainBtn = document.getElementById("main-button");
    const webModalBtn = document.getElementById("webmodal");
    const downloadBtn = document.getElementById("download-btn");
    const openInAppBtn = document.getElementById("open-in-app-btn");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const closeBtnWebModal = document.getElementById("close-webmodal-btn");
    const modal = $("#modal");
    const webModal = $('#webmodal');


    var isMobile = {
        Windows: function () {
            return /IEMobile/i.test(navigator.userAgent);
        },
        Android: function () {
            return /Android/i.test(navigator.userAgent);
        },
        BlackBerry: function () {
            return /BlackBerry/i.test(navigator.userAgent);
        },
        iOS: function () {
            return /iPhone|Macintosh|iPad|iPod/i.test(navigator.userAgent);
        },
        iPhone: function () {
            return /iPhone|Macintosh|iPod/i.test(navigator.userAgent);
        },
        iPad: function () {
            return /iPad/i.test(navigator.userAgent);
        },
        any: function () {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Windows());
        }
    };

    const redirectToMarket = function() {
        if (isMobile.iOS()) {
            window.location.href = "https://itunes.apple.com/app/fizy-music-video/id404239912?mt=8"
        }
        if (isMobile.Android()) {
            window.location.href = "https://play.google.com/store/apps/details?id=com.turkcell.gncplay"
        }
    };

    const redirectToFizy = function() {
        window.location.href = "http://play.fizy.com/"
    };

    const iOSVersion = function() {
        return parseFloat(
            ('' + (/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent) || [0,''])[1])
            .replace('undefined', '3_2').replace('_', '.').replace('_', '')
        );
    }

    const openMobileApp = function() {
        const isDocumentHidden = function() {
                return document.hidden || document.visibilityState === 'hidden' || document['webkitHidden'];
        } 
        var timeoutId;
        const docVisibilityChangeListener = function() {
            if (isDocumentHidden()) { // We have successfully switched to mobile Fizy app.
                clearTimeout(timeoutId); // So we no longer need to get redirected to the market.
            }
        };

        // Set fallback timeout: if there is no mobile Fizy app installed - redirect to the market.
        timeoutId = setTimeout(function() {
            document.removeEventListener('visibilitychange', docVisibilityChangeListener);
            if (isDocumentHidden()) {
                redirectToMarket();
            }

            
        }, 1);

        // Track document visibility changes.
        document.addEventListener('visibilitychange', docVisibilityChangeListener);

        // Try to open mobile Fizy app.
        // const mobilePathQuery = location.pathname.startsWith('/error') ?
        //     '' :
        //     `${location.pathname}${location.search}`;
        try {
            window.location.href = `http://listen.fizy.com/timeline`
        } catch (e) {
            console.log(e)
        }
    };

    const onOpenModal = function() {
        modal.fadeIn();
    }

    const onOpenWebModal = function() {
        webModal.fadeIn();
    }

    const onCloseModal = function() {
        modal.fadeOut();
    };

    const onCloseWebModal = function() {
        webModal.fadeOut();
    };

    const buttonHandler = function() {
        if (isMobile.any()) {
            onOpenModal();
        } else {
            onOpenWebModal();
        }
    };



    openInAppBtn.addEventListener("click", openMobileApp);
    downloadBtn.addEventListener("click", redirectToMarket);
    closeModalBtn.addEventListener("click", onCloseModal);
    closeBtnWebModal.addEventListener("click", onCloseWebModal);
    mainBtn.addEventListener("click", buttonHandler);

    /*var iOS7 = navigator.userAgent.match(/(iPad|iPhone|iPod).*OS 7_\d/i);
    var iOS8 = navigator.userAgent.match(/(iPad|iPhone|iPod).*OS 8_\d/i);
    var iOS9 = navigator.userAgent.match(/(iPad|iPhone|iPod).*OS 9_\d/i);
    if (iOS7 || iOS8 || iOS9) {
        alert(navigator.userAgent);
        
        alert(iOS8);
        alert(iOS9);
        var elements = document.getElementsByClassName("loader");
        while (elements.length > 0) {
            elements[0].parentNode.removeChild(elements[0]);
        }
    } */
});

$(window).on('load', function () {
    $(".loader").fadeOut("slow");
    $(".page-wrapper").css("visibility", "visible");
});